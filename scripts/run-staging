#!/bin/bash

# Script to run Ansible playbook for staging environment,
# ensuring SSH key from vault is loaded into ssh-agent.

# Source helper functions and variables
HELPER_SCRIPT_PATH="$(dirname "${BASH_SOURCE[0]}")/helpers.sh"
if [ -f "$HELPER_SCRIPT_PATH" ]; then
  # shellcheck source=./helpers.sh
  source "$HELPER_SCRIPT_PATH"
else
  echo "ERROR: helpers.sh not found at $HELPER_SCRIPT_PATH"
  exit 1
fi

# Set script-specific log level
SCRIPT_LOG_LEVEL=$_LOG_LEVEL_INFO
export SCRIPT_LOG_LEVEL

log_debug "run-staging script started."
ensure_ansible_root_dir

# Check for required dependencies using helper functions
check_vault_password_file
check_yq_installed
check_ansible_vault_installed
check_ansible_installed

log_info "Running Ansible playbook for staging environment..."

# All sudo passwords are now stored in the vault, no prompting needed
log_info "Using sudo passwords from vault, no prompting required."

# Use the simplified environment function
if ! run_environment_playbook "staging" "$@"; then
  log_error "Ansible playbook failed for staging."
  exit 1
else
  log_info "Ansible playbook completed successfully for staging."
fi

log_debug "run-staging script finished."
