#!/bin/bash
# Simple script to launch two separate player instances for dual screens
# This avoids the complexity of managing multiple windows in a single Python process

PLAYER_DIR="{{ player.video_source }}"
VENV_PYTHON="${PLAYER_DIR}/.venv/bin/python"
LOGS_DIR="${PLAYER_DIR}/logs"

# Ensure logs directory exists
mkdir -p "$LOGS_DIR"

# Clean up deprecated log files
rm -f "$LOGS_DIR/player.stdout.log" "$LOGS_DIR/player.stderr.log" "$LOGS_DIR/health_check.log" "$LOGS_DIR/health_check_error.log"

# Log start time
echo "[$(date '+%Y-%m-%d %H:%M:%S')] Starting dual-screen player launcher" >> "$LOGS_DIR/player.log"

# Kill any existing player processes
pkill -f "python.*oaplayer.*screen=1" || true
pkill -f "python.*oaplayer.*screen=2" || true
sleep 1

# Start both players concurrently
echo "[$(date '+%Y-%m-%d %H:%M:%S')] Launching both players concurrently" >> "$LOGS_DIR/player.log"

# Start player for screen 1 with explicit position
SDL_VIDEODRIVER=cocoa SDL_VIDEO_WINDOW_POS="0,0" DISPLAY=:0 \
"$VENV_PYTHON" "$PLAYER_DIR/oaplayer.py" \
  --config "$PLAYER_DIR/player_config.json" \
  --screen=1 \
  --log-prefix="PLAYER1" \
  >> "$LOGS_DIR/player.log" 2>&1 &
PLAYER1_PID=$!

# Start player for screen 2 with explicit position immediately
SDL_VIDEODRIVER=cocoa SDL_VIDEO_WINDOW_POS="1082,0" DISPLAY=:0 \
"$VENV_PYTHON" "$PLAYER_DIR/oaplayer.py" \
  --config "$PLAYER_DIR/player_config.json" \
  --screen=2 \
  --log-prefix="PLAYER2" \
  >> "$LOGS_DIR/player.log" 2>&1 &
PLAYER2_PID=$!

# Keep the parent process alive to maintain LaunchAgent
echo "[$(date '+%Y-%m-%d %H:%M:%S')] Both players launched, monitoring..." >> "$LOGS_DIR/player.log"

# Use a simple infinite loop instead of 'sleep infinity' for better compatibility
while true; do
  # Check if player 1 process is running
  if ! pgrep -f "python.*oaplayer.*screen=1" > /dev/null; then
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] WARNING: Player 1 not detected, restarting..." >> "$LOGS_DIR/player.log"
    
    # Start player for screen 1
    SDL_VIDEODRIVER=cocoa SDL_VIDEO_WINDOW_POS="0,0" DISPLAY=:0 \
    "$VENV_PYTHON" "$PLAYER_DIR/oaplayer.py" \
      --config "$PLAYER_DIR/player_config.json" \
      --screen=1 \
      --log-prefix="PLAYER1" \
      >> "$LOGS_DIR/player.log" 2>&1 &
  fi
  
  # Check if player 2 process is running
  if ! pgrep -f "python.*oaplayer.*screen=2" > /dev/null; then
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] WARNING: Player 2 not detected, restarting..." >> "$LOGS_DIR/player.log"
    
    # Start player for screen 2
    SDL_VIDEODRIVER=cocoa SDL_VIDEO_WINDOW_POS="1082,0" DISPLAY=:0 \
    "$VENV_PYTHON" "$PLAYER_DIR/oaplayer.py" \
      --config "$PLAYER_DIR/player_config.json" \
      --screen=2 \
      --log-prefix="PLAYER2" \
      >> "$LOGS_DIR/player.log" 2>&1 &
  fi
  
  # Sleep for 10 seconds before checking again
  sleep 10
done
