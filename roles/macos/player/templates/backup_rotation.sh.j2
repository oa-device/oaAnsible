#!/bin/bash

# Backup Rotation Script for OrangeAd Player
# Generated by oaAnsible player role

set -e

# Configuration
VIDEO_SOURCE="{{ player.video_source }}"
BACKUP_RETENTION_DAYS="{{ video_files.backup_retention_days | default(7) }}"
LOG_FILE="{{ player.video_source }}/logs/backup_rotation.log"

# Ensure log directory exists
mkdir -p "$(dirname "$LOG_FILE")"

# Logging function
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

log "Starting backup rotation (retention: ${BACKUP_RETENTION_DAYS} days)"

# Find and remove old backup files
if [ -d "$VIDEO_SOURCE" ]; then
    # Count backups before cleanup
    backup_count_before=$(find "$VIDEO_SOURCE" -name "*.backup.*" -type f 2>/dev/null | wc -l)
    log "Found $backup_count_before backup files before cleanup"
    
    # Remove backups older than retention period
    deleted_count=0
    while IFS= read -r -d '' backup_file; do
        log "Removing old backup: $(basename "$backup_file")"
        rm -f "$backup_file"
        ((deleted_count++))
    done < <(find "$VIDEO_SOURCE" -name "*.backup.*" -type f -mtime "+${BACKUP_RETENTION_DAYS}" -print0 2>/dev/null)
    
    # Count remaining backups
    backup_count_after=$((backup_count_before - deleted_count))
    log "Cleanup complete: removed $deleted_count backups, $backup_count_after remaining"
    
    # Log disk usage for video directory
    if command -v du >/dev/null 2>&1; then
        disk_usage=$(du -sh "$VIDEO_SOURCE" 2>/dev/null | cut -f1 || echo "unknown")
        log "Current video directory size: $disk_usage"
    fi
else
    log "WARNING: Video source directory not found: $VIDEO_SOURCE"
fi

log "Backup rotation completed"