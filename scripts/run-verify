#!/bin/bash

# Post-deployment verification script
# Usage: ./run-verify <environment> [scope]
# Example: ./run-verify staging
# Example: ./run-verify production macos_api

# Source helper functions and variables
HELPER_SCRIPT_PATH="$(dirname "${BASH_SOURCE[0]}")/helpers.sh"
if [ -f "$HELPER_SCRIPT_PATH" ]; then
  # shellcheck source=./helpers.sh
  source "$HELPER_SCRIPT_PATH"
else
  echo "ERROR: helpers.sh not found at $HELPER_SCRIPT_PATH"
  exit 1
fi

# Set script-specific log level
SCRIPT_LOG_LEVEL=$_LOG_LEVEL_INFO
export SCRIPT_LOG_LEVEL

# Usage function
usage() {
  cat << EOF
Usage: $0 <environment> [scope]

ENVIRONMENTS:
  staging       - Use staging inventory
  production    - Use production inventory  
  preprod       - Use pre-production inventory

VERIFICATION SCOPES:
  all           - Verify all deployed components (default)
  base_system   - Verify base system configuration
  network       - Verify network and Tailscale configuration
  macos_api     - Verify macOS API service
  tracker       - Verify oaTracker service
  alpr          - Verify ALPR service
  services      - Verify all services status

EXAMPLES:
  $0 staging                    # Verify all components on staging
  $0 production macos_api       # Verify only macOS API on production
  $0 staging services           # Verify all services status

EOF
}

# Check arguments
if [ $# -lt 1 ]; then
  log_error "Invalid number of arguments"
  usage
  exit 1
fi

ENVIRONMENT=$1
SCOPE=${2:-all}

log_debug "run-verify script started for environment: $ENVIRONMENT, scope: $SCOPE"

ensure_ansible_root_dir

# Validate environment
case $ENVIRONMENT in
  staging|production|preprod)
    INVENTORY_FILE="$OA_ANSIBLE_INVENTORY_DIR/$ENVIRONMENT/hosts.yml"
    if [ ! -f "$INVENTORY_FILE" ]; then
      log_error "Inventory file not found: $INVENTORY_FILE"
      exit 1
    fi
    ;;
  *)
    log_error "Invalid environment: $ENVIRONMENT"
    log_error "Valid environments: staging, production, preprod"
    exit 1
    ;;
esac

# Validate scope
VALID_SCOPES=("all" "base_system" "network" "macos_api" "tracker" "alpr" "services")
if [[ ! " ${VALID_SCOPES[*]} " =~ " $SCOPE " ]]; then
  log_error "Invalid scope: $SCOPE"
  log_error "Valid scopes: ${VALID_SCOPES[*]}"
  exit 1
fi

# --- SSH Agent Key Loading ---
log_info "Checking and loading SSH key into agent for verification..."
check_vault_password_file
check_yq_installed
check_ansible_vault_installed
check_ansible_installed

# Load SSH key from vault
VAULT_YML_FILE="$OA_ANSIBLE_GROUP_VARS_DIR/all/vault.yml"

if ! ssh-add -l >/dev/null 2>&1; then
  log_info "ssh-agent not running or no keys loaded. Starting agent..."
  eval "$(ssh-agent -s)" >/dev/null
fi

log_info "Loading SSH key from vault..."
if ansible-vault view "$VAULT_YML_FILE" --vault-password-file "$OA_ANSIBLE_VAULT_PASSWORD_FILE" |
  yq -re '.vault_ssh_private_key // ""' |
  ssh-add - >/dev/null 2>&1; then
  log_info "SSH key successfully loaded."
else
  if ssh-add -l >/dev/null 2>&1; then
    log_warn "Could not add key from vault, but keys are present in agent."
  else
    log_error "Failed to load SSH key and no keys in agent. SSH authentication may fail."
  fi
fi

# --- Verification ---
log_info "Starting deployment verification..."
log_info "Environment: $ENVIRONMENT"
log_info "Scope: $SCOPE"

# Create verification playbook
VERIFICATION_PLAYBOOK=$(cat << 'EOF'
---
- name: Post-Deployment Verification
  hosts: all
  gather_facts: true
  vars:
    verification_scope: "{{ verify_scope | default('all') }}"
  
  tasks:
    - name: Display verification info
      ansible.builtin.debug:
        msg: |
          Verification Scope: {{ verification_scope }}
          Target Host: {{ inventory_hostname }}
          Platform: {{ ansible_distribution }}
    
    - name: Import verification tasks
      ansible.builtin.import_tasks: tasks/verify.yml
      vars:
        verify_scope: "{{ verification_scope }}"
    
    - name: Additional service status checks
      block:
        - name: Check macOS services (if macOS)
          ansible.builtin.shell: |
            launchctl list | grep orangead || echo "No OrangeAd services found"
          register: macos_services
          when: ansible_distribution == "MacOSX"
          failed_when: false
        
        - name: Display macOS service status
          ansible.builtin.debug:
            msg: "macOS Services: {{ macos_services.stdout_lines }}"
          when: 
            - ansible_distribution == "MacOSX"
            - macos_services is defined
        
        - name: Check Tailscale status
          ansible.builtin.command: tailscale status --json
          register: tailscale_status
          failed_when: false
          become: false
        
        - name: Display Tailscale status
          ansible.builtin.debug:
            msg: |
              Tailscale Status: {{ 'Connected' if tailscale_status.rc == 0 else 'Not Connected' }}
              {% if tailscale_status.rc != 0 %}
              Error: {{ tailscale_status.stderr | default('Unknown error') }}
              {% endif %}
      when: verification_scope in ['all', 'services', 'network']
    
    - name: Verification summary
      ansible.builtin.debug:
        msg: |
          Verification completed for {{ inventory_hostname }}
          Scope: {{ verification_scope }}
          Platform: {{ ansible_distribution }}
          Status: Check output above for any failures
EOF
)

# Write temporary verification playbook
TEMP_PLAYBOOK="/tmp/oaansible-verify-$$.yml"
echo "$VERIFICATION_PLAYBOOK" > "$TEMP_PLAYBOOK"

log_info "Executing verification playbook..."

# Execute verification
ANSIBLE_CONFIG=ansible.cfg ansible-playbook \
  "$TEMP_PLAYBOOK" \
  -i "$INVENTORY_FILE" \
  --extra-vars "verify_scope=$SCOPE" \
  --tags "verify" \
  "$@"

VERIFICATION_EXIT_CODE=$?

# Clean up temporary playbook
rm -f "$TEMP_PLAYBOOK"

if [ $VERIFICATION_EXIT_CODE -eq 0 ]; then
  log_info "Verification completed successfully."
  log_info "Scope: $SCOPE, Environment: $ENVIRONMENT"
else
  log_error "Verification failed with exit code $VERIFICATION_EXIT_CODE."
  log_error "Check the output above for specific issues."
fi

# Additional local verification for common issues
log_info "Performing additional local checks..."

case $SCOPE in
  all|network)
    log_info "Checking network connectivity to inventory hosts..."
    # Extract hosts from inventory and test connectivity
    if command -v yq >/dev/null 2>&1; then
      HOSTS=$(yq eval '.all.hosts | keys | .[]' "$INVENTORY_FILE" 2>/dev/null || echo "Unable to parse hosts")
      if [ "$HOSTS" != "Unable to parse hosts" ]; then
        for host in $HOSTS; do
          HOST_IP=$(yq eval ".all.hosts.$host.ansible_host" "$INVENTORY_FILE" 2>/dev/null)
          if [ -n "$HOST_IP" ] && [ "$HOST_IP" != "null" ]; then
            if ping -c 1 -W 2 "$HOST_IP" >/dev/null 2>&1; then
              log_info "✓ $host ($HOST_IP) is reachable"
            else
              log_warn "✗ $host ($HOST_IP) is not reachable"
            fi
          fi
        done
      fi
    fi
    ;;
esac

log_debug "run-verify script finished."
exit $VERIFICATION_EXIT_CODE