---
- name: Configure macOS for OrangeAd
  hosts: all
  gather_facts: false
  tags: ["macos"]

  pre_tasks:
    - name: Gather facts
      setup:

    - name: Debug connection info
      debug:
        msg: |
          Connection Details:
          - Host: {{ ansible_host }}
          - User: {{ ansible_user }}
          - Python: {{ ansible_python.executable }}

    - name: Verify target is macOS
      fail:
        msg: "This playbook only supports macOS"
      when: ansible_distribution != "MacOSX"

    - name: Ensure system requirements are met
      import_tasks: tasks/pre_checks.yml
      tags: ["always"]

  roles:
    - role: elliotweiser.osx-command-line-tools
      become: yes
      tags: ["cli", "setup"]

    - role: geerlingguy.mac.homebrew
      tags: ["homebrew", "setup"]

    - role: macos/base
      tags: ["setup", "configuration"]

    - role: macos/ssh
      tags: ["ssh", "security", "setup"]

    - role: macos/network # General network settings, DNS
      tags: ["network", "dns"]

    - role: macos/network/tailscale # Installs tailscale binaries and deploys plist
      tags: ["tailscale", "network"]

    - role: macos/python
      tags: ["python", "dev"]

    - role: macos/node
      tags: ["node", "dev"]

    - role: macos/security # Firewall rules, including for tailscaled
      tags: ["security", "configuration"]

    - role: macos/settings
      tags: ["settings", "configuration"]

    - role: macos/api
      tags: ["api", "services"]

  post_tasks:
    - name: Verify installation
      import_tasks: tasks/verify.yml
      tags: ["verify"]

    - name: Display completion message
      debug:
        msg: |
          Installation completed successfully!
          Please restart your terminal to apply all changes.
      tags: ["always"]
