#!/bin/bash

# Platform-specific full deployment script
# Usage: ./run-platform <environment> <platform>
# Example: ./run-platform staging macos
# Example: ./run-platform production ubuntu

# Source helper functions and variables
HELPER_SCRIPT_PATH="$(dirname "${BASH_SOURCE[0]}")/helpers.sh"
if [ -f "$HELPER_SCRIPT_PATH" ]; then
  # shellcheck source=./helpers.sh
  source "$HELPER_SCRIPT_PATH"
else
  echo "ERROR: helpers.sh not found at $HELPER_SCRIPT_PATH"
  exit 1
fi

# Set script-specific log level
SCRIPT_LOG_LEVEL=$_LOG_LEVEL_INFO
export SCRIPT_LOG_LEVEL

# Usage function
usage() {
  cat << EOF
Usage: $0 <environment> <platform>

ENVIRONMENTS:
  staging       - Use staging inventory
  production    - Use production inventory  
  preprod       - Use pre-production inventory

PLATFORMS:
  macos         - Force macOS full deployment
  ubuntu        - Force Ubuntu full deployment
  orangepi      - Force OrangePi full deployment
  auto          - Auto-detect platform (default)

EXAMPLES:
  $0 staging macos        # Force macOS deployment on staging
  $0 production auto      # Auto-detect platform for production
  $0 staging ubuntu       # Force Ubuntu deployment on staging

EOF
}

# Check arguments
if [ $# -lt 1 ]; then
  log_error "Invalid number of arguments"
  usage
  exit 1
fi

ENVIRONMENT=$1
PLATFORM=${2:-auto}

log_debug "run-platform script started for environment: $ENVIRONMENT, platform: $PLATFORM"

ensure_ansible_root_dir

# Validate environment
case $ENVIRONMENT in
  staging|production)
    INVENTORY_FILE="$OA_ANSIBLE_INVENTORY_DIR/$ENVIRONMENT/hosts.yml"
    if [ ! -f "$INVENTORY_FILE" ]; then
      log_error "Inventory file not found: $INVENTORY_FILE"
      exit 1
    fi
    ;;
  preprod|pre-prod)
    # Handle both preprod and pre-prod naming
    INVENTORY_FILE="$OA_ANSIBLE_INVENTORY_DIR/pre-prod/hosts.yml"
    if [ ! -f "$INVENTORY_FILE" ]; then
      log_error "Inventory file not found: $INVENTORY_FILE"
      exit 1
    fi
    ;;
  *)
    log_error "Invalid environment: $ENVIRONMENT"
    log_error "Valid environments: staging, production, preprod, pre-prod"
    exit 1
    ;;
esac

# Validate platform
case $PLATFORM in
  macos|ubuntu|orangepi|auto)
    log_info "Platform: $PLATFORM"
    ;;
  *)
    log_error "Invalid platform: $PLATFORM"
    log_error "Valid platforms: macos, ubuntu, orangepi, auto"
    exit 1
    ;;
esac

# Check for required dependencies (SSH and vault loading handled by run_playbook_with_vault)
check_vault_password_file
check_yq_installed
check_ansible_vault_installed
check_ansible_installed

# --- Platform Deployment ---
log_info "Starting platform deployment..."
log_info "Environment: $ENVIRONMENT"
log_info "Platform: $PLATFORM"

# Determine playbook and extra vars
if [ "$PLATFORM" = "auto" ]; then
  PLAYBOOK="playbooks/universal.yml"
  EXTRA_VARS="execution_mode=full"
  log_info "Using universal playbook with auto-detection"
else
  case $PLATFORM in
    macos)
      PLAYBOOK="playbooks/macos-full.yml"
      EXTRA_VARS=""
      ;;
    ubuntu)
      PLAYBOOK="playbooks/ubuntu-full.yml"
      EXTRA_VARS=""
      ;;
    orangepi)
      PLAYBOOK="playbooks/orangepi-full.yml"
      EXTRA_VARS=""
      ;;
  esac
  log_info "Using platform-specific playbook: $PLAYBOOK"
fi

# Check if playbook exists
if [ ! -f "$PLAYBOOK" ]; then
  log_error "Playbook not found: $PLAYBOOK"
  
  if [ "$PLATFORM" = "ubuntu" ] || [ "$PLATFORM" = "orangepi" ]; then
    log_error "Note: Ubuntu and OrangePi full playbooks will be implemented in Phase 5"
    log_info "Using universal playbook as fallback..."
    PLAYBOOK="playbooks/universal.yml"
    EXTRA_VARS="execution_mode=full force_platform=$PLATFORM"
  else
    exit 1
  fi
fi

log_info "Executing platform deployment..."

# Execute the appropriate playbook
if [ -n "$EXTRA_VARS" ]; then
  if ! run_playbook_with_vault "$PLAYBOOK" "$INVENTORY_FILE" "$ENVIRONMENT $PLATFORM deployment" --extra-vars "$EXTRA_VARS" "$@"; then
    log_error "Platform deployment failed."
    exit 1
  fi
else
  if ! run_playbook_with_vault "$PLAYBOOK" "$INVENTORY_FILE" "$ENVIRONMENT $PLATFORM deployment" "$@"; then
    log_error "Platform deployment failed."
    exit 1
  fi
fi

log_info "Platform deployment completed successfully."
log_info "Environment: $ENVIRONMENT, Platform: $PLATFORM"

log_debug "run-platform script finished."