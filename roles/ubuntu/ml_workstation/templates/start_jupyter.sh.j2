#!/bin/bash
# Jupyter Lab Startup Script for ML Development
# Generated by Ansible oaAnsible/roles/ubuntu/ml_workstation

OASENTINEL_HOME="{{ ubuntu_oasentinel.install_dir | default(ansible_user_dir + '/oaSentinel') }}"
JUPYTER_PORT="{{ ubuntu_training_server.jupyter_port | default(8888) }}"

echo "Starting Jupyter Lab for ML Development"
echo "=========================================="

# Navigate to oaSentinel directory
cd "$OASENTINEL_HOME"

# Check if virtual environment exists
if [ ! -f ".venv/bin/activate" ]; then
    echo "[FAIL] Virtual environment not found at $OASENTINEL_HOME/.venv"
    exit 1
fi

# Activate virtual environment
source .venv/bin/activate
echo "[OK] Virtual environment activated"

# Create Jupyter config directory if it doesn't exist
mkdir -p "$HOME/.jupyter"

# Check if Jupyter is running
if pgrep -f "jupyter-lab.*port.*$JUPYTER_PORT" > /dev/null; then
    echo "Jupyter Lab already running on port $JUPYTER_PORT"
    echo "Access at: http://{{ inventory_hostname }}:$JUPYTER_PORT"
    echo "Or via SSH tunnel: ssh -L $JUPYTER_PORT:localhost:$JUPYTER_PORT {{ ansible_user }}@{{ inventory_hostname }}"
    exit 0
fi

# Start Jupyter Lab
echo "Starting Jupyter Lab on port $JUPYTER_PORT..."
echo "Working directory: $OASENTINEL_HOME"
echo ""

# Create a screen session for Jupyter
screen -dmS jupyter-lab

# Start Jupyter in the screen session
screen -S jupyter-lab -X stuff "cd $OASENTINEL_HOME && source .venv/bin/activate && jupyter lab --config=$HOME/.jupyter/jupyter_lab_config.py 2>&1 | tee logs/jupyter.log\n"

# Wait a moment for startup
sleep 3

# Check if it started successfully
if pgrep -f "jupyter-lab.*port.*$JUPYTER_PORT" > /dev/null; then
    echo "[OK] Jupyter Lab started successfully!"
    echo ""
    echo "Access Options:"
    echo "  Local:      http://localhost:$JUPYTER_PORT"
    echo "  Network:    http://{{ inventory_hostname }}:$JUPYTER_PORT"
    echo "  SSH Tunnel: ssh -L $JUPYTER_PORT:localhost:$JUPYTER_PORT {{ ansible_user }}@{{ inventory_hostname }}"
    echo ""
    echo "Screen session: screen -r jupyter-lab"
    echo "Stop with: screen -S jupyter-lab -X quit"
    echo "Logs: tail -f logs/jupyter.log"
else
    echo "[FAIL] Failed to start Jupyter Lab"
    echo "Check logs: screen -r jupyter-lab"
    exit 1
fi